<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conferidor Mega Sena</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Conferidor da Mega Sena</h1>
        
        {% if ultimo_resultado %}
        <div class="ultimo-resultado">
            <h2>Último Sorteio</h2>
            <p>Concurso: {{ ultimo_resultado.concurso }} - Data: {{ ultimo_resultado.data }}</p>
            <div class="numeros">
                {% for numero in ultimo_resultado.dezenas %}
                <span class="bola">{{ numero }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="conferidor">
            <h2>Confira seu Jogo</h2>
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('digitar')">Digitar Números</button>
                <button class="tab-btn" onclick="showTab('arquivo')">Enviar Arquivo</button>
            </div>

            <div id="tab-digitar" class="tab-content" style="display: block;">
                <p>Digite ou cole seus números (separados por espaços ou vírgulas)</p>
                <form id="form-conferir" onsubmit="conferirJogo(event)">
                    <textarea 
                        name="numeros" 
                        id="numeros" 
                        rows="3" 
                        placeholder="Ex: 01 02 03 04 05 06 ou 1,2,3,4,5,6" 
                        required
                    ></textarea>
                    <button type="submit">Conferir Números</button>
                </form>
            </div>

            <div id="tab-arquivo" class="tab-content" style="display: none;">
                <div 
                    id="drop-zone" 
                    class="drop-zone"
                    ondrop="dropHandler(event)" 
                    ondragover="dragOverHandler(event)"
                    ondragleave="dragLeaveHandler(event)"
                >
                    <div class="drop-zone-content">
                        <p>Arraste e solte seu arquivo .txt aqui</p>
                        <p>ou</p>
                        <input type="file" id="fileInput" accept=".txt" onchange="handleFileSelect(event)" />
                        <label for="fileInput" class="file-input-label">Escolher Arquivo</label>
                    </div>
                </div>
            </div>
        </div>

        <div id="resultado" class="resultado" style="display: none;">
            <h2>Resultado da Conferência</h2>
            <div class="grid-info">
                <div class="info-box">
                    <h3>Dezenas Apostadas</h3>
                    <p id="qtd-dezenas">-</p>
                </div>
                <div class="info-box">
                    <h3>Acertos</h3>
                    <p id="acertos">-</p>
                </div>
                <div class="info-box">
                    <h3>Valor Gasto</h3>
                    <p id="valor-gasto">-</p>
                </div>
            </div>
            <div id="numeros-acertados" class="numeros-acertados">
                <h3>Números Acertados</h3>
                <div id="lista-acertos" class="numeros"></div>
            </div>
        </div>
    </div>

    <script>
        async function conferirJogo(event) {
            event.preventDefault();
            const form = event.target;
            const resultado = document.getElementById('resultado');
            
            try {
                const response = await fetch('/conferir', {
                    method: 'POST',
                    body: new FormData(form)
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }

                atualizarResultado(data.resultado);
            } catch (error) {
                alert('Erro ao conferir o jogo. Tente novamente.');
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(`tab-${tabName}`).style.display = 'block';
            event.target.classList.add('active');
        }

        function dragOverHandler(event) {
            event.preventDefault();
            event.target.classList.add('dragover');
        }

        function dragLeaveHandler(event) {
            event.preventDefault();
            event.target.classList.remove('dragover');
        }

        function atualizarResultado(resultado) {
            document.getElementById('qtd-dezenas').textContent = resultado.qtd_dezenas;
            document.getElementById('acertos').textContent = resultado.acertos;
            document.getElementById('valor-gasto').textContent = 
                `R$ ${resultado.valor_gasto.toFixed(2)}`;

            const listaAcertos = document.getElementById('lista-acertos');
            listaAcertos.innerHTML = resultado.numeros_acertados
                .map(n => `<span class="bola">${String(n).padStart(2, '0')}</span>`)
                .join('');

            document.getElementById('resultado').style.display = 'block';
        }

        async function processFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.error) {
                    alert(data.error);
                    return;
                }

                atualizarResultado(data.resultado);
            } catch (error) {
                alert('Erro ao processar o arquivo. Tente novamente.');
            }
        }

        function dropHandler(event) {
            event.preventDefault();
            event.target.classList.remove('dragover');

            const file = event.dataTransfer.files[0];
            if (file && file.name.toLowerCase().endsWith('.txt')) {
                processFile(file);
            } else {
                alert('Por favor, envie apenas arquivos .txt');
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }
    </script>
</body>
</html>